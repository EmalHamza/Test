/**
 * @fileoverview added by tsickle
 * Generated from: lib/directives/typeahead/typeahead.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Injector, forwardRef, Input, ViewChild } from '@angular/core';
import { Subject, merge } from 'rxjs';
import { debounceTime, map, distinctUntilChanged, filter } from 'rxjs/operators';
import { SelectionService } from '../selection-by-api/selection-by-api';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { NgbTypeahead } from '@ng-bootstrap/ng-bootstrap';
export class TypeaheadComponent {
    /**
     * @param {?} api
     * @param {?} injector
     */
    constructor(api, injector) {
        this.api = api;
        this.injector = injector;
        this.focus$ = new Subject();
        this.click$ = new Subject();
        this.statesWithFlags = [];
        this.UPLOAD_DIRECTIVE_HEADERS = this.injector.get('UPLOAD_DIRECTIVE_HEADERS');
        this.UPLOAD_DIRECTIVE_API_URL = this.injector.get('UPLOAD_DIRECTIVE_API_URL');
        this.url = (/**
         * @param {?} apiUrl
         * @param {?} search
         * @return {?}
         */
        (apiUrl, search) => {
            return apiUrl + this.apiUpload + search;
            // tslint:disable-next-line:semicolon
        });
        // search = (text$: Observable<string>) =>
        //   text$.pipe(
        //     debounceTime(200),
        //     map(term =>
        //       term === '' ? [] : this.statesWithFlags.filter(v => v[this.searchBy].toLowerCase().indexOf(term.toLowerCase()) > -1).slice(0, 10)
        //     )
        //     // tslint:disable-next-line:semicolon
        //   );
        this.search = (/**
         * @param {?} text$
         * @return {?}
         */
        (text$) => {
            /** @type {?} */
            const debouncedText$ = text$.pipe(debounceTime(200), distinctUntilChanged());
            /** @type {?} */
            const clicksWithClosedPopup$ = this.click$.pipe(filter((/**
             * @return {?}
             */
            () => !this.instance.isPopupOpen())));
            /** @type {?} */
            const inputFocus$ = this.focus$;
            return merge(debouncedText$, inputFocus$, clicksWithClosedPopup$).pipe(
            // tslint:disable-next-line:max-line-length
            // map(term =>
            //   term === '' ? [] : this.statesWithFlags.filter(v => v[this.searchBy].toLowerCase().indexOf(term.toLowerCase()) > -1).slice(0, 10)
            // )
            map((/**
             * @param {?} term
             * @return {?}
             */
            term => 
            // tslint:disable-next-line:max-line-length
            term === ''
                ? this.statesWithFlags
                : this.statesWithFlags.filter((/**
                 * @param {?} v
                 * @return {?}
                 */
                v => v[this.searchBy].toLowerCase().indexOf(term.toLowerCase()) > -1)).slice(0, 10))));
            // tslint:disable-next-line:semicolon
        });
        this.propagateChange = (/**
         * @param {?} val
         * @return {?}
         */
        (val) => { });
    }
    /**
     * @return {?}
     */
    ngOnInit() { }
    /**
     * @return {?}
     */
    ngOnChanges() {
        setTimeout((/**
         * @return {?}
         */
        () => {
            if (this.isClear) {
                this.value = null;
                this.model = this.value;
            }
        }), 1);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        setTimeout((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const apiT = this.url(this.UPLOAD_DIRECTIVE_API_URL, '');
            /** @type {?} */
            const requestHeaders = this.UPLOAD_DIRECTIVE_HEADERS;
            this.api.getAll(apiT, requestHeaders, this.method).subscribe((/**
             * @param {?} response
             * @return {?}
             */
            response => {
                this.statesWithFlags = this.resultTransformer(response);
            }));
            if (this.value) {
                this.model = this.value;
            }
        }), 1);
    }
    /**
     * @param {?} val
     * @return {?}
     */
    filterData(val) {
        if (typeof val !== 'object') {
            /** @type {?} */
            const api = this.url(this.UPLOAD_DIRECTIVE_API_URL, val);
            /** @type {?} */
            const requestHeaders = this.UPLOAD_DIRECTIVE_HEADERS;
            this.api.getAll(api, requestHeaders, this.method).subscribe((/**
             * @param {?} response
             * @return {?}
             */
            response => {
                this.statesWithFlags = this.resultTransformer(response);
            }));
        }
        else {
            this.value = val;
        }
    }
    /**
     * @return {?}
     */
    get value() {
        return this._value;
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set value(val) {
        this._value = val;
        this.propagateChange(this._value);
    }
    /**
     * @param {?} value
     * @return {?}
     */
    writeValue(value) {
        if (value !== undefined) {
            this.value = value;
        }
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    registerOnChange(fn) {
        this.propagateChange = fn;
    }
    /**
     * @return {?}
     */
    registerOnTouched() { }
}
TypeaheadComponent.decorators = [
    { type: Component, args: [{
                // tslint:disable-next-line:component-selector
                selector: 'typeahead',
                template: "<div>\n  <ng-template #rt let-r=\"result\" let-t=\"term\">\n    <ngb-highlight *ngFor=\"let i of keyName\" [result]=\"r[i]\" [term]=\"t\"></ngb-highlight>\n  </ng-template>\n  <input\n    id=\"rf-typeahead-template-{{ id }}\"\n    type=\"text\"\n    class=\"form-control\"\n    [(ngModel)]=\"model\"\n    [ngbTypeahead]=\"search\"\n    [resultTemplate]=\"rt\"\n    [inputFormatter]=\"fieldName\"\n    (ngModelChange)=\"filterData(model)\"\n    (focus)=\"focus$.next($event.target.value)\"\n    (click)=\"click$.next($event.target.value)\"\n    #instance=\"ngbTypeahead\"\n  />\n</div>\n",
                providers: [
                    {
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef((/**
                         * @return {?}
                         */
                        () => TypeaheadComponent)),
                        multi: true
                    },
                    SelectionService
                ],
                styles: ["ngb-highlight{position:relative;margin-right:15px}ngb-highlight:after{position:absolute;content:'-';top:0;right:-10px}ngb-highlight:last-child:after{position:absolute;content:''}"]
            }] }
];
/** @nocollapse */
TypeaheadComponent.ctorParameters = () => [
    { type: SelectionService },
    { type: Injector }
];
TypeaheadComponent.propDecorators = {
    _value: [{ type: Input }],
    id: [{ type: Input }],
    resultTransformer: [{ type: Input }],
    apiUpload: [{ type: Input }],
    keyName: [{ type: Input }],
    method: [{ type: Input }],
    fieldName: [{ type: Input }],
    searchBy: [{ type: Input }],
    isClear: [{ type: Input }],
    instance: [{ type: ViewChild, args: ['instance', {},] }]
};
if (false) {
    /** @type {?} */
    TypeaheadComponent.prototype._value;
    /** @type {?} */
    TypeaheadComponent.prototype.id;
    /** @type {?} */
    TypeaheadComponent.prototype.resultTransformer;
    /** @type {?} */
    TypeaheadComponent.prototype.apiUpload;
    /** @type {?} */
    TypeaheadComponent.prototype.keyName;
    /** @type {?} */
    TypeaheadComponent.prototype.method;
    /** @type {?} */
    TypeaheadComponent.prototype.fieldName;
    /** @type {?} */
    TypeaheadComponent.prototype.searchBy;
    /** @type {?} */
    TypeaheadComponent.prototype.isClear;
    /** @type {?} */
    TypeaheadComponent.prototype.instance;
    /** @type {?} */
    TypeaheadComponent.prototype.focus$;
    /** @type {?} */
    TypeaheadComponent.prototype.click$;
    /** @type {?} */
    TypeaheadComponent.prototype.statesWithFlags;
    /** @type {?} */
    TypeaheadComponent.prototype.model;
    /** @type {?} */
    TypeaheadComponent.prototype.UPLOAD_DIRECTIVE_HEADERS;
    /** @type {?} */
    TypeaheadComponent.prototype.UPLOAD_DIRECTIVE_API_URL;
    /** @type {?} */
    TypeaheadComponent.prototype.url;
    /** @type {?} */
    TypeaheadComponent.prototype.search;
    /** @type {?} */
    TypeaheadComponent.prototype.propagateChange;
    /**
     * @type {?}
     * @private
     */
    TypeaheadComponent.prototype.api;
    /**
     * @type {?}
     * @private
     */
    TypeaheadComponent.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZWFoZWFkLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B2aWNvZGVycy9yZWFjdGl2ZS1mb3JtLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvdHlwZWFoZWFkL3R5cGVhaGVhZC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFFBQVEsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUE0QixTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDcEgsT0FBTyxFQUFjLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFFLFlBQVksRUFBRSxHQUFHLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDeEUsT0FBTyxFQUFFLGlCQUFpQixFQUF3QixNQUFNLGdCQUFnQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQWUxRCxNQUFNLE9BQU8sa0JBQWtCOzs7OztJQXFEN0IsWUFBb0IsR0FBcUIsRUFBVSxRQUFrQjtRQUFqRCxRQUFHLEdBQUgsR0FBRyxDQUFrQjtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7UUF6Q3JFLFdBQU0sR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQy9CLFdBQU0sR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3hCLG9CQUFlLEdBQVUsRUFBRSxDQUFDO1FBRTVCLDZCQUF3QixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDekUsNkJBQXdCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsQ0FBQztRQUN6RSxRQUFHOzs7OztRQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzlCLE9BQU8sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDO1lBQ3hDLHFDQUFxQztRQUN2QyxDQUFDLEVBQUM7Ozs7Ozs7OztRQVNGLFdBQU07Ozs7UUFBRyxDQUFDLEtBQXlCLEVBQUUsRUFBRTs7a0JBQy9CLGNBQWMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUMvQixZQUFZLENBQUMsR0FBRyxDQUFDLEVBQ2pCLG9CQUFvQixFQUFFLENBQ3ZCOztrQkFDSyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNOzs7WUFBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLEVBQUMsQ0FBQzs7a0JBQ3JGLFdBQVcsR0FBRyxJQUFJLENBQUMsTUFBTTtZQUUvQixPQUFPLEtBQUssQ0FBQyxjQUFjLEVBQUUsV0FBVyxFQUFFLHNCQUFzQixDQUFDLENBQUMsSUFBSTtZQUNwRSwyQ0FBMkM7WUFDM0MsY0FBYztZQUNkLHNJQUFzSTtZQUN0SSxJQUFJO1lBQ0osR0FBRzs7OztZQUFDLElBQUksQ0FBQyxFQUFFO1lBQ1QsMkNBQTJDO1lBQzNDLElBQUksS0FBSyxFQUFFO2dCQUNULENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZTtnQkFDdEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTTs7OztnQkFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFDbkgsQ0FDRixDQUFDO1lBQ0YscUNBQXFDO1FBQ3ZDLENBQUMsRUFBQztRQUdGLG9CQUFlOzs7O1FBQUcsQ0FBQyxHQUFRLEVBQUUsRUFBRSxHQUFFLENBQUMsRUFBQztJQURxQyxDQUFDOzs7O0lBR3pFLFFBQVEsS0FBSSxDQUFDOzs7O0lBRWIsV0FBVztRQUNULFVBQVU7OztRQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDaEIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7Z0JBQ2xCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQzthQUN6QjtRQUNILENBQUMsR0FBRSxDQUFDLENBQUMsQ0FBQztJQUNSLENBQUM7Ozs7SUFFRCxlQUFlO1FBQ2IsVUFBVTs7O1FBQUMsR0FBRyxFQUFFOztrQkFDUixJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsRUFBRSxDQUFDOztrQkFDbEQsY0FBYyxHQUFHLElBQUksQ0FBQyx3QkFBd0I7WUFDcEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUzs7OztZQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUN0RSxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMxRCxDQUFDLEVBQUMsQ0FBQztZQUNILElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDZCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7YUFDekI7UUFDSCxDQUFDLEdBQUUsQ0FBQyxDQUFDLENBQUM7SUFDUixDQUFDOzs7OztJQUVELFVBQVUsQ0FBQyxHQUFHO1FBQ1osSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLEVBQUU7O2tCQUNyQixHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxDQUFDOztrQkFDbEQsY0FBYyxHQUFHLElBQUksQ0FBQyx3QkFBd0I7WUFDcEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLGNBQWMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUzs7OztZQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNyRSxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMxRCxDQUFDLEVBQUMsQ0FBQztTQUNKO2FBQU07WUFDTCxJQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQztTQUNsQjtJQUNILENBQUM7Ozs7SUFFRCxJQUFJLEtBQUs7UUFDUCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDckIsQ0FBQzs7Ozs7SUFFRCxJQUFJLEtBQUssQ0FBQyxHQUFHO1FBQ1gsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUM7UUFDbEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDcEMsQ0FBQzs7Ozs7SUFFRCxVQUFVLENBQUMsS0FBVTtRQUNuQixJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDdkIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7U0FDcEI7SUFDSCxDQUFDOzs7OztJQUVELGdCQUFnQixDQUFDLEVBQUU7UUFDakIsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7SUFDNUIsQ0FBQzs7OztJQUVELGlCQUFpQixLQUFJLENBQUM7OztZQTdIdkIsU0FBUyxTQUFDOztnQkFFVCxRQUFRLEVBQUUsV0FBVztnQkFDckIsc2xCQUF5QztnQkFFekMsU0FBUyxFQUFFO29CQUNUO3dCQUNFLE9BQU8sRUFBRSxpQkFBaUI7d0JBQzFCLFdBQVcsRUFBRSxVQUFVOzs7d0JBQUMsR0FBRyxFQUFFLENBQUMsa0JBQWtCLEVBQUM7d0JBQ2pELEtBQUssRUFBRSxJQUFJO3FCQUNaO29CQUNELGdCQUFnQjtpQkFDakI7O2FBQ0Y7Ozs7WUFoQlEsZ0JBQWdCO1lBSEcsUUFBUTs7O3FCQXFCakMsS0FBSztpQkFDTCxLQUFLO2dDQUNMLEtBQUs7d0JBQ0wsS0FBSztzQkFDTCxLQUFLO3FCQUNMLEtBQUs7d0JBQ0wsS0FBSzt1QkFDTCxLQUFLO3NCQUNMLEtBQUs7dUJBRUwsU0FBUyxTQUFDLFVBQVUsRUFBRSxFQUFFOzs7O0lBVnpCLG9DQUFnQjs7SUFDaEIsZ0NBQVk7O0lBQ1osK0NBQTJCOztJQUMzQix1Q0FBbUI7O0lBQ25CLHFDQUFpQjs7SUFDakIsb0NBQWdCOztJQUNoQix1Q0FBbUI7O0lBQ25CLHNDQUFrQjs7SUFDbEIscUNBQ2lCOztJQUNqQixzQ0FBa0Q7O0lBQ2xELG9DQUErQjs7SUFDL0Isb0NBQStCOztJQUMvQiw2Q0FBbUM7O0lBQ25DLG1DQUFrQjs7SUFDbEIsc0RBQWdGOztJQUNoRixzREFBZ0Y7O0lBQ2hGLGlDQUdFOztJQVNGLG9DQXFCRTs7SUFHRiw2Q0FBbUM7Ozs7O0lBRHZCLGlDQUE2Qjs7Ozs7SUFBRSxzQ0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgSW5qZWN0b3IsIGZvcndhcmRSZWYsIElucHV0LCBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgbWVyZ2UgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgbWFwLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgU2VsZWN0aW9uU2VydmljZSB9IGZyb20gJy4uL3NlbGVjdGlvbi1ieS1hcGkvc2VsZWN0aW9uLWJ5LWFwaSc7XG5pbXBvcnQgeyBOR19WQUxVRV9BQ0NFU1NPUiwgQ29udHJvbFZhbHVlQWNjZXNzb3IgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBOZ2JUeXBlYWhlYWQgfSBmcm9tICdAbmctYm9vdHN0cmFwL25nLWJvb3RzdHJhcCc7XG5AQ29tcG9uZW50KHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmNvbXBvbmVudC1zZWxlY3RvclxuICBzZWxlY3RvcjogJ3R5cGVhaGVhZCcsXG4gIHRlbXBsYXRlVXJsOiAnLi90eXBlYWhlYWQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi90eXBlYWhlYWQuY29tcG9uZW50LmNzcyddLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IFR5cGVhaGVhZENvbXBvbmVudCksXG4gICAgICBtdWx0aTogdHJ1ZVxuICAgIH0sXG4gICAgU2VsZWN0aW9uU2VydmljZVxuICBdXG59KVxuZXhwb3J0IGNsYXNzIFR5cGVhaGVhZENvbXBvbmVudCBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uQ2hhbmdlcyB7XG4gIEBJbnB1dCgpIF92YWx1ZTtcbiAgQElucHV0KCkgaWQ7XG4gIEBJbnB1dCgpIHJlc3VsdFRyYW5zZm9ybWVyO1xuICBASW5wdXQoKSBhcGlVcGxvYWQ7XG4gIEBJbnB1dCgpIGtleU5hbWU7XG4gIEBJbnB1dCgpIG1ldGhvZDtcbiAgQElucHV0KCkgZmllbGROYW1lO1xuICBASW5wdXQoKSBzZWFyY2hCeTtcbiAgQElucHV0KClcbiAgaXNDbGVhcjogQm9vbGVhbjtcbiAgQFZpZXdDaGlsZCgnaW5zdGFuY2UnLCB7fSkgaW5zdGFuY2U6IE5nYlR5cGVhaGVhZDtcbiAgZm9jdXMkID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xuICBjbGljayQgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XG4gIHB1YmxpYyBzdGF0ZXNXaXRoRmxhZ3M6IGFueVtdID0gW107XG4gIHB1YmxpYyBtb2RlbDogYW55O1xuICBwdWJsaWMgVVBMT0FEX0RJUkVDVElWRV9IRUFERVJTID0gdGhpcy5pbmplY3Rvci5nZXQoJ1VQTE9BRF9ESVJFQ1RJVkVfSEVBREVSUycpO1xuICBwdWJsaWMgVVBMT0FEX0RJUkVDVElWRV9BUElfVVJMID0gdGhpcy5pbmplY3Rvci5nZXQoJ1VQTE9BRF9ESVJFQ1RJVkVfQVBJX1VSTCcpO1xuICBwdWJsaWMgdXJsID0gKGFwaVVybCwgc2VhcmNoKSA9PiB7XG4gICAgcmV0dXJuIGFwaVVybCArIHRoaXMuYXBpVXBsb2FkICsgc2VhcmNoO1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzZW1pY29sb25cbiAgfTtcbiAgLy8gc2VhcmNoID0gKHRleHQkOiBPYnNlcnZhYmxlPHN0cmluZz4pID0+XG4gIC8vICAgdGV4dCQucGlwZShcbiAgLy8gICAgIGRlYm91bmNlVGltZSgyMDApLFxuICAvLyAgICAgbWFwKHRlcm0gPT5cbiAgLy8gICAgICAgdGVybSA9PT0gJycgPyBbXSA6IHRoaXMuc3RhdGVzV2l0aEZsYWdzLmZpbHRlcih2ID0+IHZbdGhpcy5zZWFyY2hCeV0udG9Mb3dlckNhc2UoKS5pbmRleE9mKHRlcm0udG9Mb3dlckNhc2UoKSkgPiAtMSkuc2xpY2UoMCwgMTApXG4gIC8vICAgICApXG4gIC8vICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c2VtaWNvbG9uXG4gIC8vICAgKTtcbiAgc2VhcmNoID0gKHRleHQkOiBPYnNlcnZhYmxlPHN0cmluZz4pID0+IHtcbiAgICBjb25zdCBkZWJvdW5jZWRUZXh0JCA9IHRleHQkLnBpcGUoXG4gICAgICBkZWJvdW5jZVRpbWUoMjAwKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICApO1xuICAgIGNvbnN0IGNsaWNrc1dpdGhDbG9zZWRQb3B1cCQgPSB0aGlzLmNsaWNrJC5waXBlKGZpbHRlcigoKSA9PiAhdGhpcy5pbnN0YW5jZS5pc1BvcHVwT3BlbigpKSk7XG4gICAgY29uc3QgaW5wdXRGb2N1cyQgPSB0aGlzLmZvY3VzJDtcblxuICAgIHJldHVybiBtZXJnZShkZWJvdW5jZWRUZXh0JCwgaW5wdXRGb2N1cyQsIGNsaWNrc1dpdGhDbG9zZWRQb3B1cCQpLnBpcGUoXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAvLyBtYXAodGVybSA9PlxuICAgICAgLy8gICB0ZXJtID09PSAnJyA/IFtdIDogdGhpcy5zdGF0ZXNXaXRoRmxhZ3MuZmlsdGVyKHYgPT4gdlt0aGlzLnNlYXJjaEJ5XS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodGVybS50b0xvd2VyQ2FzZSgpKSA+IC0xKS5zbGljZSgwLCAxMClcbiAgICAgIC8vIClcbiAgICAgIG1hcCh0ZXJtID0+XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgdGVybSA9PT0gJydcbiAgICAgICAgICA/IHRoaXMuc3RhdGVzV2l0aEZsYWdzXG4gICAgICAgICAgOiB0aGlzLnN0YXRlc1dpdGhGbGFncy5maWx0ZXIodiA9PiB2W3RoaXMuc2VhcmNoQnldLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih0ZXJtLnRvTG93ZXJDYXNlKCkpID4gLTEpLnNsaWNlKDAsIDEwKVxuICAgICAgKVxuICAgICk7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnNlbWljb2xvblxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBpOiBTZWxlY3Rpb25TZXJ2aWNlLCBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge31cbiAgcHJvcGFnYXRlQ2hhbmdlID0gKHZhbDogYW55KSA9PiB7fTtcblxuICBuZ09uSW5pdCgpIHt9XG5cbiAgbmdPbkNoYW5nZXMoKSB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5pc0NsZWFyKSB7XG4gICAgICAgIHRoaXMudmFsdWUgPSBudWxsO1xuICAgICAgICB0aGlzLm1vZGVsID0gdGhpcy52YWx1ZTtcbiAgICAgIH1cbiAgICB9LCAxKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGNvbnN0IGFwaVQgPSB0aGlzLnVybCh0aGlzLlVQTE9BRF9ESVJFQ1RJVkVfQVBJX1VSTCwgJycpO1xuICAgICAgY29uc3QgcmVxdWVzdEhlYWRlcnMgPSB0aGlzLlVQTE9BRF9ESVJFQ1RJVkVfSEVBREVSUztcbiAgICAgIHRoaXMuYXBpLmdldEFsbChhcGlULCByZXF1ZXN0SGVhZGVycywgdGhpcy5tZXRob2QpLnN1YnNjcmliZShyZXNwb25zZSA9PiB7XG4gICAgICAgIHRoaXMuc3RhdGVzV2l0aEZsYWdzID0gdGhpcy5yZXN1bHRUcmFuc2Zvcm1lcihyZXNwb25zZSk7XG4gICAgICB9KTtcbiAgICAgIGlmICh0aGlzLnZhbHVlKSB7XG4gICAgICAgIHRoaXMubW9kZWwgPSB0aGlzLnZhbHVlO1xuICAgICAgfVxuICAgIH0sIDEpO1xuICB9XG5cbiAgZmlsdGVyRGF0YSh2YWwpIHtcbiAgICBpZiAodHlwZW9mIHZhbCAhPT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IGFwaSA9IHRoaXMudXJsKHRoaXMuVVBMT0FEX0RJUkVDVElWRV9BUElfVVJMLCB2YWwpO1xuICAgICAgY29uc3QgcmVxdWVzdEhlYWRlcnMgPSB0aGlzLlVQTE9BRF9ESVJFQ1RJVkVfSEVBREVSUztcbiAgICAgIHRoaXMuYXBpLmdldEFsbChhcGksIHJlcXVlc3RIZWFkZXJzLCB0aGlzLm1ldGhvZCkuc3Vic2NyaWJlKHJlc3BvbnNlID0+IHtcbiAgICAgICAgdGhpcy5zdGF0ZXNXaXRoRmxhZ3MgPSB0aGlzLnJlc3VsdFRyYW5zZm9ybWVyKHJlc3BvbnNlKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnZhbHVlID0gdmFsO1xuICAgIH1cbiAgfVxuXG4gIGdldCB2YWx1ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fdmFsdWU7XG4gIH1cblxuICBzZXQgdmFsdWUodmFsKSB7XG4gICAgdGhpcy5fdmFsdWUgPSB2YWw7XG4gICAgdGhpcy5wcm9wYWdhdGVDaGFuZ2UodGhpcy5fdmFsdWUpO1xuICB9XG5cbiAgd3JpdGVWYWx1ZSh2YWx1ZTogYW55KSB7XG4gICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcbiAgICB9XG4gIH1cblxuICByZWdpc3Rlck9uQ2hhbmdlKGZuKSB7XG4gICAgdGhpcy5wcm9wYWdhdGVDaGFuZ2UgPSBmbjtcbiAgfVxuXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKCkge31cbn1cblxuLy8gaHR0cHM6Ly9uZy1ib290c3RyYXAuZ2l0aHViLmlvLyMvY29tcG9uZW50cy90eXBlYWhlYWQvZXhhbXBsZXNcbiJdfQ==